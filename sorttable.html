<html>

<head>
	<title>Test Event Model</title>
	<script src="eventmodel.js"></script>

	<link rel="data" href="data.json" />

	<style>
		th {
			cursor: pointer;
		}
		
		.current::after {
			content: '\25BE';
		}
	</style>
</head>

<body>

	<p>The table is bound to the data object. Click on a header to sort the column. Click a cell to edit the contents. Edits are reflected in the data object.</p>
	
	<table>
		<thead>
			<tr>
				<th>Id</th>
				<th>Name</th>
				<th>Value</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>

	<script>
		var data = [
			{ "Id": 1, "Name": "Apple", "Value": "Simple" },
			{ "Id": 2, "Name": "Banana", "Value": "Complex" },
			{ "Id": 3, "Name": "Date", "Value": "Refactor" },
			{ "Id": 4, "Name": "Apple", "Value": "Abstract" },
			{ "Id": 5, "Name": "Carrot", "Value": "Concrete" },
			{ "Id": 6, "Name": "Fig", "Value": "Interface" }
		];
		
		function foreach(array, fn) { for (var i in array) fn(array[i], i); }
		function forall(arraylike, fn) { for (var i = 0; i < arraylike.length; i++) fn(arraylike[i], i); }
		
		var m = new EventModel({
			"tbody": {
				bound: function(e, model) {
					var tbody = this;
					foreach (data, function(item) {
						var row = tbody.insertRow();
						row.dataitem = item;
						foreach (item, function(value) {
							var cell = row.insertCell();
							cell.textContent = value;
						});
					});
				},
				sort: function(e, model) {
					var sorted = Array.prototype.slice.call(this.children).sort(function(a, b) {
						return a.children[e.data].textContent < b.children[e.data].textContent ? -1 : 1;
					});
					for (var i in sorted) this.appendChild(sorted[i]);
				}
			},
			"thead tr": {
				click: function(e, model) {
					model.sort(Array.prototype.slice.call(this.children).indexOf(e.target));
					model.clear();
					e.target.classList.add('current');
				}
			},
			"th": {
				clear: function(e, model) { this.classList.remove('current'); }
			},
			"tbody;tr": new EventModel({
				base: {
					update: function(e, model) {
						var tr = this;
						var map = { "0": "Id", "1": "Name", "2": "Value" };
						var values = model.value();
						foreach(map, function(key, ix) { tr.dataitem[key] = values[ix]; });
					}
				},
				"td": {
					click: function() {
						var input = document.createElement('input');
						input.value = this.textContent;
						this.textContent = null;
						this.appendChild(input);
						input.focus();
						input.setSelectionRange(0, input.value.length);
					},
					value: function() { return this.textContent; }
				},
				"base;input": {
					blur: function(e, model) { 
						this.parentElement.innerHTML = this.value; 
						model.update(); 
					},
					keyup: function(e) { if (e.keyCode == 13) this.blur(); }
				}
			})
		});
		m.bind();
	
	</script>
</body>

</html>